name: Backup Cron Jobs

on:
  schedule:
    # fetch-content & process-ai-jobs - every 15 minutes
    - cron: '*/15 * * * *'
    # discover-games - every 6 hours
    - cron: '0 */6 * * *'
    # backfill-release-dates - every 2 hours
    - cron: '15 */2 * * *'
    # cleanup-content - daily at 4 AM UTC
    - cron: '0 4 * * *'
    # scan-seasonal - weekly on Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

env:
  BASE_URL: https://patchpulse.vercel.app

jobs:
  frequent-crons:
    # Runs every 15 minutes
    if: github.event.schedule == '*/15 * * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger fetch-content
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/fetch-content" \
            --max-time 300 || echo "fetch-content failed or timed out"

      - name: Trigger process-ai-jobs
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/process-ai-jobs" \
            --max-time 120 || echo "process-ai-jobs failed or timed out"

      - name: Trigger backfill-news-images
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/backfill-news-images" \
            --max-time 120 || echo "backfill-news-images failed or timed out"

  discover-games:
    if: github.event.schedule == '0 */6 * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger discover-games
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/discover-games" \
            --max-time 300 || echo "discover-games failed or timed out"

      - name: Trigger backfill-images (30 min offset simulated)
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/backfill-images" \
            --max-time 300 || echo "backfill-images failed or timed out"

  backfill-release-dates:
    if: github.event.schedule == '15 */2 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger backfill-release-dates
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/backfill-release-dates" \
            --max-time 300 || echo "backfill-release-dates failed or timed out"

  cleanup-content:
    if: github.event.schedule == '0 4 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger cleanup-content
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/cleanup-content" \
            --max-time 120 || echo "cleanup-content failed or timed out"

  scan-seasonal:
    if: github.event.schedule == '0 0 * * 0'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger scan-seasonal
        run: |
          curl -sf -X GET \
            -H "x-vercel-cron: 1" \
            "${{ env.BASE_URL }}/api/cron/scan-seasonal" \
            --max-time 300 || echo "scan-seasonal failed or timed out"
